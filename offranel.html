<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Offranel üõçÔ∏è</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="icon" href="logo.png" type="image/png">
  <style>
    /* (CSS identique √† ton pr√©c√©dent) */
    * { box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: #fffaf5;
      margin: 0;
      padding: 0;
      color: #333;
    }
    header {
      background: linear-gradient(90deg, #ff7a00, #ff9a3d);
      color: white;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    header h1 {
      margin: 0;
      font-size: 22px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    header nav {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    header nav button {
      background: white;
      color: #ff7a00;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }
    header nav button:hover { background: #ffe0c2; }
    .container { padding: 20px; max-width: 1200px; margin: auto; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap: 15px; }
    .card { background: white; border-radius: 15px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); overflow: hidden; transition: transform 0.2s; }
    .card:hover { transform: scale(1.02); }
    .card img { width: 100%; height: 180px; object-fit: cover; }
    .card-body { padding: 10px; }
    .user { font-weight: 600; color: #ff7a00; display: flex; align-items: center; gap: 5px; font-size: 14px; }
    .price { font-size: 18px; font-weight: bold; color: #ff7a00; }
    .date { font-size: 12px; color: #777; }
    form { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); max-width: 450px; margin: 20px auto; display: flex; flex-direction: column; gap: 10px; }
    input, select, textarea, button { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; width: 100%; }
    button.publish { background: #ff7a00; color: white; font-weight: 600; border: none; transition: background 0.3s; cursor: pointer; }
    button.publish:hover { background: #e66a00; }
    .preview img { width: 100%; border-radius: 10px; margin-top: 10px; }
    .hidden { display: none; }
    .profile img { border-radius: 50%; width: 90px; height: 90px; object-fit: cover; }
    ul { list-style: none; padding: 0; }
    li { background: white; margin-bottom: 8px; padding: 10px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    @media (max-width: 600px) {
      header { flex-direction: column; align-items: flex-start; }
      header nav { width: 100%; justify-content: space-around; }
      .card img { height: 150px; }
    }
    .popup {
      position: fixed;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      min-width: 280px;
      max-width: 90vw;
      background: #fff;
      color: #333;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.18);
      padding: 18px 28px;
      font-size: 16px;
      z-index: 9999;
      display: flex;
      align-items: center;
      gap: 12px;
      border-left: 6px solid #ff7a00;
      animation: popupIn 0.3s;
    }
    .popup.success { border-left-color: #2ecc40; }
    .popup.error { border-left-color: #ff3b3b; }
    .popup .fa-solid { font-size: 20px; }
    .popup.hidden { display: none; }
    @keyframes popupIn { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }
    .profile-card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.10);
      padding: 32px 24px 24px 24px;
      max-width: 400px;
      margin: 30px auto 18px auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    .profile-card .profile-avatar {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid #ff7a00;
      margin-top: -70px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(255,122,0,0.10);
    }
    .profile-card h2 {
      margin: 18px 0 6px 0;
      color: #ff7a00;
      font-size: 1.5em;
      font-weight: 700;
      text-align: center;
    }
    .profile-card .profile-email {
      color: #888;
      font-size: 1em;
      margin-bottom: 10px;
      text-align: center;
    }
    .profile-card .profile-bio {
      color: #444;
      font-size: 1.08em;
      margin: 10px 0 0 0;
      text-align: center;
    }
    .profile-card .profile-company {
      margin-top: 18px;
      font-weight: 600;
      color: #ff7a00;
      font-size: 1.1em;
      text-align: center;
    }
    .profile-card .profile-actions {
      margin-top: 18px;
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    .profile-card .profile-actions button {
      background: #ff7a00;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 18px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .profile-card .profile-actions button:hover {
      background: #e66a00;
    }
    @media (max-width: 600px) {
      .profile-card { padding: 18px 6vw 18px 6vw; }
      .profile-card .profile-avatar { width: 80px; height: 80px; margin-top: -50px; }
    }
    .skeleton-card {
      background: #f3f3f3;
      border-radius: 15px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.06);
      overflow: hidden;
      animation: skeletonPulse 1.2s infinite ease-in-out;
    }
    .skeleton-img {
      width: 100%;
      height: 180px;
      background: linear-gradient(90deg, #ececec 25%, #f5f5f5 50%, #ececec 75%);
      background-size: 200% 100%;
      animation: skeletonMove 1.2s infinite linear;
    }
    .skeleton-line {
      border-radius: 6px;
      background: linear-gradient(90deg, #ececec 25%, #f5f5f5 50%, #ececec 75%);
      background-size: 200% 100%;
      animation: skeletonMove 1.2s infinite linear;
    }
    @keyframes skeletonMove {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    @keyframes skeletonPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    @media (max-width: 600px) {
      .skeleton-img { height: 120px; }
    }
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.35);
      z-index: 10000;
    }
    .modal-content {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      color: #333;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      padding: 32px 24px 24px 24px;
      min-width: 320px;
      max-width: 95vw;
      z-index: 10001;
      display: flex;
      flex-direction: column;
      align-items: center;
      animation: popupIn 0.3s;
    }
    .modal-img {
      width: 100%;
      max-width: 340px;
      border-radius: 12px;
      margin-bottom: 18px;
      object-fit: cover;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .modal-content h2 {
      color: #ff7a00;
      margin: 0 0 10px 0;
      text-align: center;
    }
    .modal-content .price {
      font-size: 1.3em;
      font-weight: bold;
      color: #ff7a00;
      margin-bottom: 8px;
    }
    .modal-content .user {
      font-size: 1em;
      margin-bottom: 8px;
      color: #555;
    }
    .modal-content .phone {
      font-size: 1em;
      color: #009e3c;
      margin-left: 8px;
    }
    .modal-content .date {
      font-size: 0.95em;
      color: #888;
      margin-bottom: 12px;
    }
    .modal-content .publish, .modal-content .whatsapp {
      width: 100%;
      margin: 8px 0 0 0;
      padding: 12px;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: bold;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    .modal-content .publish { background: #ff7a00; color: #fff; }
    .modal-content .publish:hover { background: #e66a00; }
    .modal-content .whatsapp { background: #25d366; color: #fff; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .modal-content .whatsapp:hover { background: #1ebe57; }
    .close-modal {
      position: absolute;
      top: 10px; right: 18px;
      background: none;
      border: none;
      font-size: 2em;
      color: #ff7a00;
      cursor: pointer;
      z-index: 10002;
    }
    @media (max-width: 600px) {
      .modal-content { min-width: 90vw; padding: 18px 4vw 18px 4vw; }
      .modal-img { max-width: 95vw; }
    }
  </style>
</head>
<body>

<header>
  <h1><i class="fa-solid fa-store"></i> Offranel</h1>
  <nav>
    <button id="btnHome"><i class="fa-solid fa-house"></i></button>
    <button id="btnPublish"><i class="fa-solid fa-plus"></i></button>
    <button id="btnCart"><i class="fa-solid fa-cart-shopping"></i></button>
    <button id="btnProfile"><i class="fa-solid fa-user"></i></button>
    <button id="btnLogout" class="hidden"><i class="fa-solid fa-right-from-bracket"></i></button>
  </nav>
</header>

<div class="container" id="homePage">
  <h2>üõçÔ∏è Produits disponibles</h2>
  <div class="grid" id="productsGrid"></div>
</div>

<div class="container hidden" id="publishPage">
  <h2>üì∏ Publier un produit</h2>
  <form id="publishForm">
    <input type="text" id="description" placeholder="üìù Description du produit" required>
    <input type="number" id="price" placeholder="üí∞ Prix" required>
    <select id="currency">
      <option value="USD">$ Dollar</option>
      <option value="CDF">FC Franc Congolais</option>
    </select>
    <input type="file" id="imageInput" accept="image/*" required>
    <div class="preview" id="imagePreview"></div>
    <button type="submit" class="publish" id="publishBtn">Publier</button>
  </form>
</div>

<div class="container hidden" id="cartPage">
  <h2>üõí Mon Panier</h2>
  <ul id="cartList"></ul>
</div>

<div class="container hidden" id="profilePage">
  <div class="profile-card" id="userInfo"></div>
  <div class="profile-card profile-company">
    <h3>üè¢ Offranel SARL</h3>
    <p>Entreprise sp√©cialis√©e dans la mise en relation entre acheteurs et vendeurs üá®üá©.</p>
  </div>
</div>

<!-- POPUP NOTIFICATION -->
<div id="popup" class="popup hidden"></div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  // --- CONFIG SUPABASE ---
  const supabaseUrl = "https://lpiftgpmgenhqykdwfco.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxwaWZ0Z3BtZ2VuaHF5a2R3ZmNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3ODEzMjIsImV4cCI6MjA3NTM1NzMyMn0.IB92grHwhq2KGFdQVh-gcC3KjGse8oW5ugcUolgroek";
  const supabase = createClient(supabaseUrl, supabaseKey);

  // --- NAVIGATION ---
  const pages = {
    home: document.getElementById("homePage"),
    publish: document.getElementById("publishPage"),
    cart: document.getElementById("cartPage"),
    profile: document.getElementById("profilePage"),
  };
  const buttons = {
    home: document.getElementById("btnHome"),
    publish: document.getElementById("btnPublish"),
    cart: document.getElementById("btnCart"),
    profile: document.getElementById("btnProfile"),
    logout: document.getElementById("btnLogout"),
  };
  function showPage(page) {
    Object.values(pages).forEach(p => p.classList.add("hidden"));
    pages[page].classList.remove("hidden");
  }
  buttons.home.onclick = () => showPage("home");
  buttons.publish.onclick = () => showPage("publish");
  buttons.cart.onclick = () => { showPage("cart"); showCart(); };
  buttons.profile.onclick = () => showPage("profile");
  buttons.logout.onclick = async () => {
    await supabase.auth.signOut();
    window.location.href = "login.html";
  };

  // --- UTILISATEUR COURANT ---
  let currentUser = null;
  async function checkUser() {
    const { data: { user }, error } = await supabase.auth.getUser();
    if (user) {
      currentUser = user;
      buttons.logout.classList.remove("hidden");
      document.getElementById("userInfo").innerHTML = `
        <img class="profile-avatar" src="${user.user_metadata?.avatar || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.user_metadata?.username || user.email) + '&background=ff7a00&color=fff'}" alt="photo de profil">
        <h2>${user.user_metadata?.username || user.user_metadata?.full_name || user.email.split('@')[0]}</h2>
        <div class="profile-email">${user.email}</div>
        <div class="profile-bio" id="profileBio">${user.user_metadata?.bio || 'Bienvenue sur Offranel !'}</div>
        <div class="profile-actions">
          <button id="editProfileBtn"><i class='fa-solid fa-pen'></i> Modifier</button>
          <button id="logoutProfileBtn"><i class='fa-solid fa-right-from-bracket'></i> D√©connexion</button>
        </div>
      `;
      // Activer la d√©connexion
      document.getElementById("logoutProfileBtn").onclick = async () => {
        await supabase.auth.signOut();
        showPopup('D√©connexion r√©ussie', 'success');
        setTimeout(() => { window.location.href = 'login.html'; }, 1200);
      };
      // Activer la modification du profil (bio)
      document.getElementById("editProfileBtn").onclick = async () => {
        const currentBio = user.user_metadata?.bio || '';
        const newBio = prompt("Modifier votre bio :", currentBio);
        if (newBio !== null && newBio !== currentBio) {
          const { error } = await supabase.auth.updateUser({ data: { bio: newBio } });
          if (error) {
            showPopup("Erreur lors de la mise √† jour : " + error.message, "error");
          } else {
            showPopup("Bio mise √† jour !", "success");
            checkUser();
          }
        }
      };
    } else {
      window.location.href = "login.html";
    }
  }
  checkUser();

  // --- PREVIEW IMAGE ---
  document.getElementById("imageInput").addEventListener("change", e => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = ev => {
        document.getElementById("imagePreview").innerHTML = `<img src="${ev.target.result}" />`;
      };
      reader.readAsDataURL(file);
    }
  });

  // --- PUBLICATION PRODUIT ---
  const publishForm = document.getElementById("publishForm");
  const publishBtn = document.getElementById("publishBtn");

  publishForm.addEventListener("submit", async e => {
    e.preventDefault();
    if (!currentUser) return showPopup("‚ö†Ô∏è Vous devez √™tre connect√© !", "error");

    const file = document.getElementById("imageInput").files[0];
    const desc = document.getElementById("description").value.trim();
    const price = document.getElementById("price").value;
    const currency = document.getElementById("currency").value;
    const phone = currentUser.user_metadata?.phone || "";
    const username = currentUser.user_metadata?.username || currentUser.email;

    if (!file || !desc || !price) return showPopup("Description, prix et image requis.", "error");

    publishBtn.disabled = true;
    publishBtn.textContent = "Publication en cours...";

    try {
      // --- Upload image dans Supabase Storage ---
      const fileName = Date.now() + "_" + file.name;
      const { data: uploadData, error: uploadError } = await supabase.storage
        .from('products')
        .upload(fileName, file);
      if (uploadError) throw uploadError;

      const { data: { publicUrl } } = supabase.storage.from('products').getPublicUrl(fileName);

      // --- Insert produit dans Supabase DB ---
      const { error: insertError } = await supabase
        .from('products')
        .insert([{
          user: username,
          phone: phone,
          description: desc,
          price: price,
          currency: currency,
          imageUrl: publicUrl,
          created_at: new Date().toISOString(),
          isAdmin: currentUser.email === "admin@offranel.com"
        }]);
      if (insertError) throw insertError;

      showPopup("‚úÖ Publication r√©ussie !", "success");
      publishForm.reset();
      document.getElementById("imagePreview").innerHTML = "";
      showPage("home");
      loadProducts();

    } catch(err) {
      console.error(err);
      showPopup("Erreur lors de la publication : " + (err.message || err), "error");
    } finally {
      publishBtn.disabled = false;
      publishBtn.textContent = "Publier";
    }
  });

  // --- PANIER LOCAL ---
  let cart = JSON.parse(localStorage.getItem("cart")) || [];
  function addToCart(p) {
    cart.push(p);
    localStorage.setItem("cart", JSON.stringify(cart));
    showPopup("üõí Produit ajout√© au panier !", "success");
  }
  const cartList = document.getElementById("cartList");
  function showCart() {
    cartList.innerHTML = "";
    if (cart.length === 0) {
      cartList.innerHTML = "<p>Aucun produit dans le panier.</p>";
      return;
    }
    cart.forEach(item => {
      const li = document.createElement("li");
      li.innerHTML = `${item.description} - <strong>${item.price} ${item.currency}</strong>`;
      cartList.appendChild(li);
    });
  }

  // --- AFFICHAGE PRODUITS ---
  const grid = document.getElementById("productsGrid");
  const productDetailModal = document.createElement("div");
  productDetailModal.id = "productDetailModal";
  productDetailModal.className = "hidden";
  document.body.appendChild(productDetailModal);

  function showProductDetail(product) {
    productDetailModal.innerHTML = `
      <div class="modal-overlay"></div>
      <div class="modal-content">
        <button class="close-modal" id="closeProductModal">&times;</button>
        <img src="${product.imageUrl || 'https://via.placeholder.com/300x180?text=Image'}" alt="${product.description || ''}" class="modal-img">
        <h2>${product.description || ''}</h2>
        <div class="price">${product.price} ${product.currency}</div>
        <div class="user">Vendeur : ${product.user || 'Utilisateur'} ${product.phone ? `<span class='phone'>${product.phone}</span>` : ''}</div>
        <div class="date">${product.created_at ? new Date(product.created_at).toLocaleString() : ''}</div>
        <button class="publish" id="addToCartDetail">üõí Ajouter au panier</button>
        <button class="whatsapp" id="whatsappBtn"><i class="fa-brands fa-whatsapp"></i> Contacter sur WhatsApp</button>
      </div>
    `;
    productDetailModal.classList.remove("hidden");
    document.getElementById("closeProductModal").onclick = () => productDetailModal.classList.add("hidden");
    document.getElementById("addToCartDetail").onclick = () => {
      addToCart(product);
      showPopup("Produit ajout√© au panier !", "success");
    };
    document.getElementById("whatsappBtn").onclick = () => {
      if (product.phone) {
        const phone = product.phone.replace(/[^0-9+]/g, "");
        window.open(`https://wa.me/${phone}?text=Bonjour,%20je%20suis%20int√©ress√©%20par%20votre%20produit%20: %20${encodeURIComponent(product.description)}`);
      } else {
        showPopup("Num√©ro de t√©l√©phone du vendeur indisponible", "error");
      }
    };
  }

  function showLoadingSkeletons(count = 8) {
    grid.innerHTML = "";
    for (let i = 0; i < count; i++) {
      const skeleton = document.createElement("div");
      skeleton.className = "card skeleton-card";
      skeleton.innerHTML = `
        <div class='skeleton-img'></div>
        <div class='card-body'>
          <div class='skeleton-line' style='width: 60%; height: 18px; margin-bottom: 8px;'></div>
          <div class='skeleton-line' style='width: 40%; height: 16px; margin-bottom: 8px;'></div>
          <div class='skeleton-line' style='width: 80%; height: 14px;'></div>
        </div>
      `;
      grid.appendChild(skeleton);
    }
  }

  async function loadProducts() {
    showLoadingPopup();
    showLoadingSkeletons();
    const { data: products, error } = await supabase.from('products').select('*').order('created_at', { ascending: false });
    hidePopup();
    grid.innerHTML = "";
    if (error) return showPopup("Erreur lecture produits: " + error.message, "error");
    if (!products || products.length === 0) {
      grid.innerHTML = "<p>Aucun produit disponible.</p>";
      return;
    }
    products.forEach(p => {
      const card = document.createElement("div");
      card.className = "card";
      const img = document.createElement("img");
      img.src = p.imageUrl || "https://via.placeholder.com/300x180?text=Image";
      img.alt = p.description || "image";
      img.loading = "lazy";
      img.onerror = () => { img.src = "https://via.placeholder.com/300x180?text=Image"; };
      card.appendChild(img);
      card.onclick = () => showProductDetail(p);
      const body = document.createElement("div");
      body.className = "card-body";
      const userDiv = document.createElement("div");
      userDiv.className = "user";
      userDiv.innerHTML = `${p.user || 'Utilisateur'} ${p.isAdmin ? '<i class="fa-solid fa-certificate" style="color:#ff7a00"></i>' : ''}`;
      const priceDiv = document.createElement("div");
      priceDiv.className = "price";
      priceDiv.textContent = `${p.price} ${p.currency}`;
      const descP = document.createElement("p");
      descP.textContent = p.description || "";
      const dateDiv = document.createElement("div");
      dateDiv.className = "date";
      dateDiv.textContent = p.created_at ? new Date(p.created_at).toLocaleString() : "";
      const actionBtn = document.createElement("button");
      actionBtn.className = "publish";
      if (currentUser && currentUser.email === "admin@offranel.com") {
        actionBtn.textContent = "üóëÔ∏è Supprimer";
        actionBtn.addEventListener("click", (e) => { e.stopPropagation(); deleteProduct(p.id); });
      } else {
        actionBtn.textContent = "üõí Ajouter";
        actionBtn.addEventListener("click", (e) => { e.stopPropagation(); addToCart(p); showPopup("Produit ajout√© au panier !", "success"); });
      }
      body.appendChild(userDiv);
      body.appendChild(priceDiv);
      body.appendChild(descP);
      body.appendChild(dateDiv);
      body.appendChild(actionBtn);
      card.appendChild(body);
      grid.appendChild(card);
    });
  }

  // --- SUPPRESSION PRODUIT (ADMIN) ---
  async function deleteProduct(id) {
    if (!currentUser || currentUser.email !== "admin@offranel.com") return showPopup("Acc√®s refus√© ‚Äî vous devez √™tre admin.", "error");
    if (!confirm("Supprimer ce produit ?")) return;
    const { error } = await supabase.from('products').delete().eq('id', id);
    if (error) return showPopup("Erreur suppression : " + error.message, "error");
    showPopup("Produit supprim√© !", "success");
    loadProducts();
  }

  function showPopup(message, type = "error") {
    const popup = document.getElementById("popup");
    popup.className = `popup ${type}`;
    popup.innerHTML = type === "success"
      ? `<i class='fa-solid fa-circle-check' style='color:#2ecc40'></i> ${message}`
      : `<i class='fa-solid fa-circle-exclamation' style='color:#ff3b3b'></i> ${message}`;
    popup.classList.remove("hidden");
    setTimeout(() => { popup.classList.add("hidden"); }, 3500);
  }

  function showLoadingPopup(message = "Chargement en cours...") {
    const popup = document.getElementById("popup");
    popup.className = `popup loading`;
    popup.innerHTML = `<i class='fa-solid fa-spinner fa-spin' style='color:#ff7a00'></i> ${message}`;
    popup.classList.remove("hidden");
  }

  function hidePopup() {
    const popup = document.getElementById("popup");
    popup.classList.add("hidden");
  }

  loadProducts();
</script>

</body>
</html>